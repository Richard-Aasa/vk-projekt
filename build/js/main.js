function createParticle(e,n,t,r){var a=new THREE.Sprite,i=360/n*Math.random()/2,o=(e-i)*(Math.PI/180);return a.position.y=300*t-550,a.position.x=Math.cos(o)*scene.radius,a.position.z=Math.sin(o)*scene.radius,a.scale.x=a.scale.y=200/r+50*Math.random(),a}function createTracks(e){e.tracks.forEach(function(e){if(e.streamable&&null!==e.artwork_url){var n=new Image;n.src=e.artwork_url,scene.tracks.push({program:function(e){e.lineWidth=.1,e.beginPath(),e.arc(0,0,.5,0,PI2,!0),e.stroke(),e.clip(),e.scale(1,-1),e.drawImage(n,-.6,-.6,1.2,1.2),e.globalCompositeOperation="hue",e.fillStyle="black",e.fillRect(-.6,-.6,100,100)},programHover:function(e){e.lineWidth=.1,e.beginPath(),e.arc(0,0,.6,0,PI2,!0),e.stroke(),e.clip(),e.scale(1,-1),e.drawImage(n,-.6,-.6,1.2,1.2)},track:e})}});for(var n=5,t=1,r=Math.floor(scene.tracks.length/n),a=scene.tracks.length%n,i=Math.ceil(scene.tracks.length/100),o=0;n-1>o;o++)for(var c=1;r+1>c;c++){var s=createParticle(360*c/r,r,o,i);s.material=new THREE.SpriteCanvasMaterial({color:16755200*Math.random(),program:scene.tracks[t].program}),scene.add(s),t++}for(var l=r+a,c=1;l+1>c;c++){var s=createParticle(360*c/l,l,o,i);s.material=new THREE.SpriteCanvasMaterial({color:16755200*Math.random(),program:scene.tracks[t].program}),scene.add(s),t++}}function generate(e){SC.get("/playlists",{q:e}).then(function(e){e.length>0?(clearView(),SC.get("/playlists/"+e[0].id,{}).then(function(e){createTracks(e)})):console.log("NOPE")})}function createScene(){camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1701),scene=new THREE.Scene,scene.radius=1200,scene.barAmount=80,scene.binOffset=Math.cos(Math.PI/4)*scene.radius*4/scene.barAmount,scene.AudioSource=function(){var e=this,n=new(window.AudioContext||window.webkitAudioContext),t=n.createAnalyser();t.fftSize=256;var r=n.createMediaElementSource(audioElement);r.connect(t),t.connect(n.destination);var a=function(){t.getByteFrequencyData(e.streamData);for(var n=0,r=0;r<scene.barAmount;r++)n+=e.streamData[r];e.volume=n};setInterval(function(){audioElement.paused||a()},20),this.volume=0,this.streamData=new Uint8Array(scene.barAmount),this.play=function(e){audioElement.setAttribute("src",e),audioElement.play()}},audioSource=new scene.AudioSource,scene.programVisualize=function(e){for(e.fillStyle="white",e.fillRect(-79*scene.binOffset,2*-h,160*scene.binOffset,1020),bin=0;bin<audioSource.streamData.length;bin++){var n=audioSource.streamData[bin];e.fillStyle="rgb(255,"+(85+Math.ceil(115*bin/45))+",0)",e.fillRect(-bin*scene.binOffset,h,scene.binOffset-4,1.5*n),e.fillRect(bin*scene.binOffset+scene.binOffset,h,scene.binOffset-4,1.5*n),e.fillStyle="rgba(255,"+(85+Math.ceil(115*bin/45))+",0,0.4)",e.fillRect(-bin*scene.binOffset,h+.5,scene.binOffset-4,1.5*-n),e.fillRect(bin*scene.binOffset+scene.binOffset,h+.5,scene.binOffset-4,1.5*-n)}};var e=new THREE.Sprite(new THREE.SpriteCanvasMaterial({program:scene.programVisualize}));e.position.x=scene.radius+500,scene.add(e),scene.tracks=[]}function init(){createScene(),raycaster=new THREE.Raycaster,mouse=new THREE.Vector2,mouse.isDraggable=!1,renderer=new THREE.CanvasRenderer,renderer.setClearColor(16777215),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(renderer.domElement),document.addEventListener("mousemove",onDocumentMouseMove,!1),document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mousedown",onDocumentMouseDown,!1),window.addEventListener("resize",onWindowResize,!1)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth-4,window.innerHeight-4)}function onDocumentMouseMove(e){var n=DETAILS[0].getBoundingClientRect(),t=document.getElementById("nav").getBoundingClientRect();if(e.clientX<n.width&&e.clientY<n.height||e.clientX<t.right&&e.clientY<t.bottom)INTERSECTED&&(INTERSECTED.material.program=scene.tracks[scene.children.indexOf(INTERSECTED)].program),INTERSECTED=null;else{e.preventDefault(),mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=2*-(e.clientY/window.innerHeight)+1,raycaster.setFromCamera(mouse,camera);var r=raycaster.intersectObjects(scene.children);r.length>0&&!mouse.isDraggable&&scene.children.indexOf(0!=r[0].object)?INTERSECTED!=r[0].object&&(INTERSECTED&&(INTERSECTED.material.program=scene.tracks[scene.children.indexOf(INTERSECTED)].program),INTERSECTED=r[0].object,e.target.style.cursor="pointer",INTERSECTED.material.program=scene.tracks[scene.children.indexOf(INTERSECTED)].programHover):(INTERSECTED&&(INTERSECTED.material.program=scene.tracks[scene.children.indexOf(INTERSECTED)].program),INTERSECTED=null,mouse.isDraggable||(e.target.style.cursor="default"))}}function onDocumentMouseUp(e){mouse.isDraggable=!1}function clearView(){for(INTERSECTED=CLICKED=null,scene.tracks=[];1!=scene.children.length;)scene.children.pop();audioElement.pause(),audioSource.streamData=new Uint8Array(scene.barAmount),document.getElementById("info").className="invisible"}function onDocumentMouseDown(e){var n=DETAILS[0].getBoundingClientRect(),t=document.getElementById("nav").getBoundingClientRect();if(!(e.clientX<n.width&&e.clientY<n.height||e.clientX<t.right&&e.clientY<t.bottom))switch(e.preventDefault(),e.which){case 1:mouse.x=e.clientX/renderer.domElement.clientWidth*2-1,mouse.y=2*-(e.clientY/renderer.domElement.clientHeight)+1,raycaster.setFromCamera(mouse,camera);var r=raycaster.intersectObjects(scene.children);if(r.length>0&&!CLICKED){CLICKED=r[0].object,TEMP=CLICKED.scale.x;var a=scene.tracks[scene.children.indexOf(CLICKED)].track;checkInfo(),a.download_url?(document.getElementById("download").disabled=!1,download=a.download_url):document.getElementById("download").disabled=!0,a.purchase_url?(document.getElementById("buy").disabled=!1,purchase=a.purchase_url):document.getElementById("buy").disabled=!0,document.getElementById("artwork").innerHTML='<a href="'+a.permalink_url+'"><img alt="artwork" src="'+a.artwork_url+'"></a>',document.getElementById("title").innerHTML='<a href="'+a.permalink_url+'">'+a.title+"</a>",a.genre?document.getElementById("genre").innerHTML="Genre: "+a.genre:document.getElementById("genre").innerHTML=null,document.getElementById("user").innerHTML='<a href="'+a.user.permalink_url+'">'+a.user.username+"</a>",document.getElementById("license").innerHTML=a.license,document.getElementById("playback").innerHTML=a.playback_count,document.getElementById("favourite").innerHTML=a.favoritings_count,audioSource.play(a.stream_url+"?client_id="+client_id),lerpCircle()}break;case 2:mouse.isDraggable=!0;break;case 3:mouse.isDraggable=!0;break;default:console.log("weird mouse")}}function animate(){requestAnimationFrame(animate),render()}function lerpCircle(){CLICKED&&(currentFrame=requestAnimationFrame(lerpCircle),CLICKED.scale.x=CLICKED.scale.y+=8,CLICKED.scale.x>=1.5*TEMP&&(cancelAnimationFrame(currentFrame),lerpCircleBack()))}function lerpCircleBack(){CLICKED.scale.x>TEMP&&(currentFrame=requestAnimationFrame(lerpCircleBack),CLICKED.scale.x=CLICKED.scale.y-=6,CLICKED.scale.x<=TEMP&&(CLICKED.material.color=new THREE.Color(16755200),TEMP=null,CLICKED=null,cancelAnimationFrame(currentFrame)))}function render(){var e=scene.children[0],n=e.position.x,t=e.position.z;mouse.isDraggable?(e.position.x=n*Math.cos(rotSpeed*dragMultiplier*mouse.x)-t*Math.sin(rotSpeed*dragMultiplier*mouse.x),e.position.z=t*Math.cos(rotSpeed*dragMultiplier*mouse.x)+n*Math.sin(rotSpeed*dragMultiplier*mouse.x),lastMouseX=mouse.x):null===INTERSECTED&&(0>lastMouseX?(e.position.x=n*Math.cos(rotSpeed)+t*Math.sin(rotSpeed),e.position.z=t*Math.cos(rotSpeed)-n*Math.sin(rotSpeed)):(e.position.x=n*Math.cos(rotSpeed)-t*Math.sin(rotSpeed),e.position.z=t*Math.cos(rotSpeed)+n*Math.sin(rotSpeed))),camera.lookAt(e.position),renderer.render(scene,camera)}function setDownload(){window.location.href=download+client_id}function setBuy(){window.location.href=purchase}function toggleNav(){var e=document.getElementById("nav");e.classList.contains("show")?(e.className="hide",e.innerHTML="Hide",DETAILS[0].className="details"):(e.className="show",e.innerHTML="Show",DETAILS[0].className="details hidden")}function checkInfo(){var e=document.getElementById("info");e.classList.contains("invisible")&&(e.className="visible")}var audioElement=document.getElementById("player");audioElement.crossOrigin="anonymous";var camera,scene,renderer,raycaster,mouse,currentFrame,audioSource,h=window.innerHeight/6,PI2=2*Math.PI,images=[],purchase,download,INTERSECTED,CLICKED,TEMP,DETAILS=document.getElementsByClassName("details");promise.then(function(e){console.log(e),init(),animate(),createTracks(e)});var rotSpeed=.003,dragMultiplier=30,lastMouseX=0;document.getElementById("search").addEventListener("search",function(e){var n=document.getElementById("search").value;n&&generate(n)});